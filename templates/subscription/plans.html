{% extends 'rescue/base.html' %}

{% block content %}
<h2>Subscription Plans</h2>

<!-- Toggle buttons for monthly and annual views -->
<div class="d-flex justify-content-center mb-4">
    <div class="btn-group" role="group" aria-label="Subscription View">
        <button type="button" class="btn btn-secondary active" id="monthlyBtn">Monthly</button>
        <button type="button" class="btn btn-secondary" id="annualBtn">Annually</button>
    </div>
</div>

<!-- Subscription Plans -->
<div class="row" id="subscription-plans">
    {% for plan in plans %}
        <div class="col-md-4 plan-card" data-plan-id="{{ plan.id }}">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">{{ plan.plan_type|title }} Plan</h5>

                    <!-- Description of the Plan -->
                    {% if plan.plan_type == 'bronze' %}
                        <p class="card-text">Ideal for basic care and emergency assistance.</p>
                    {% elif plan.plan_type == 'silver' %}
                        <p class="card-text">For more comprehensive care with follow-up support.</p>
                    {% elif plan.plan_type == 'gold' %}
                        <p class="card-text">Complete and premium care with 24/7 access to doctors.</p>
                    {% endif %}

                    <!-- Monthly and Annual Prices -->
                    <p class="monthly-price" data-prices='{{ plan.monthly_prices|json_script:"monthly_prices" }}'>
                        <strong>Monthly:</strong> <span class="currency-symbol"></span><span class="price-value"></span>
                    </p>
                    <p class="annual-price" data-prices='{{ plan.annual_prices|json_script:"annual_prices" }}' style="display:none;">
                        <strong>Annually:</strong> <span class="currency-symbol"></span><span class="price-value"></span>
                    </p>

                    <!-- Buy button -->
                    <a href="{% url 'buy_subscription' plan.id %}" class="btn btn-primary">Buy {{ plan.plan_type|title }}</a>

                    <!-- Facilities Included for each plan -->
                    <h6 class="mt-4">Facilities Included:</h6>
                    <ul>
                        {% if plan.plan_type == 'bronze' %}
                            <li>Basic consultation with on-call doctors</li>
                            <li>Emergency assistance</li>
                        {% elif plan.plan_type == 'silver' %}
                            <li>Consultation with licensed vets</li>
                            <li>Emergency assistance and in-person visits</li>
                            <li>Follow-up care for rescued animals</li>
                        {% elif plan.plan_type == 'gold' %}
                            <li>24/7 access to a dedicated team of doctors</li>
                            <li>Emergency services and in-person visits</li>
                            <li>Comprehensive care including surgeries and rehabilitation</li>
                            <li>Regular health check-ups for rescued animals</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    {% endfor %}
</div>
{% endblock %}

{% block additional_js %}
<script>
    document.addEventListener("DOMContentLoaded", async function () {
        const monthlyBtn = document.getElementById("monthlyBtn");
        const annualBtn = document.getElementById("annualBtn");
    
        if (!monthlyBtn || !annualBtn) {
            console.error("Monthly or Annual button not found in the DOM");
            return;
        }
    
        // Currency Mapping
        const currencyMap = {
            "US": { symbol: "$", code: "USD" },
            "IN": { symbol: "₹", code: "INR" },
            "GB": { symbol: "£", code: "GBP" },
            "EU": { symbol: "€", code: "EUR" },
        };
    
        // Fetch User Country
        async function getCountryFromIP() {
            try {
                const response = await fetch('http://ip-api.com/json/');
                const data = await response.json();
                return data.countryCode || 'US'; // Default to US
            } catch (error) {
                console.error("Error fetching country:", error);
                return 'US'; // Fallback to US
            }
        }
    
        // Update Prices Dynamically
        async function updatePrices() {
            const country = await getCountryFromIP();
            console.log("User's Country:", country);
    
            const currencyInfo = currencyMap[country] || currencyMap["US"]; // Default to US if country is not in the map
            const currencySymbol = currencyInfo.symbol;
    
            document.querySelectorAll(".plan-card").forEach((plan) => {
                try {
                    // Get and parse the prices from data-prices
                    const monthlyPrices = JSON.parse(plan.querySelector(".monthly-price").getAttribute("data-prices"));
                    const annualPrices = JSON.parse(plan.querySelector(".annual-price").getAttribute("data-prices"));
    
                    console.log("Monthly Prices:", monthlyPrices);
                    console.log("Annual Prices:", annualPrices);
    
                    // Get the monthly and annual prices for the user's country
                    const monthlyPrice = monthlyPrices[country] || monthlyPrices["US"] || 0; // Fallback to US price, then 0
                    const annualPrice = annualPrices[country] || annualPrices["US"] || 0;   // Fallback to US price, then 0
    
                    console.log("Monthly Price for User's Country:", monthlyPrice);
                    console.log("Annual Price for User's Country:", annualPrice);
    
                    // Ensure prices are valid numbers
                    if (isNaN(monthlyPrice) || isNaN(annualPrice)) {
                        console.error("Invalid price data for the user's country.");
                        return;
                    }
    
                    // Update the displayed prices and currency symbol
                    plan.querySelector(".monthly-price .price-value").textContent = monthlyPrice.toFixed(2);
                    plan.querySelector(".annual-price .price-value").textContent = annualPrice.toFixed(2);
                    plan.querySelectorAll(".currency-symbol").forEach(symbol => symbol.textContent = currencySymbol);
                } catch (error) {
                    console.error("Error updating prices for plan:", plan, error);
                }
            });
        }
    
        await updatePrices();
    
        // Toggle Monthly/Annual Prices
        monthlyBtn.addEventListener("click", function () {
            this.classList.add("active");
            annualBtn.classList.remove("active");
    
            document.querySelectorAll(".plan-card").forEach(plan => {
                plan.querySelector(".monthly-price").style.display = "block";
                plan.querySelector(".annual-price").style.display = "none";
            });
        });
    
        annualBtn.addEventListener("click", function () {
            this.classList.add("active");
            monthlyBtn.classList.remove("active");
    
            document.querySelectorAll(".plan-card").forEach(plan => {
                plan.querySelector(".monthly-price").style.display = "none";
                plan.querySelector(".annual-price").style.display = "block";
            });
        });
    });     
</script>
{% endblock %}