<!-- templates/volunteer_dashboard.html -->
{% extends 'rescue/base.html' %}
{% load static %}
{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
{% endblock %}

{% block content %}
{% csrf_token %}
<h2 style="text-align: center; margin-bottom: 30px;">Volunteer Dashboard</h2> <!-- Centered heading with margin -->
<div class="task-dashboard" style="display: flex; justify-content: space-between; margin-bottom: 40px;"> <!-- Added margin for spacing -->
    <div class="task-column">
        <h3>Available Tasks</h3>
        <ul>
            {% for task in available_tasks %}
                <li>
                    <strong>{{ task.title }}</strong>
                    <p>{{ task.description }}</p>
                    <form method="POST" action="{% url 'complete_task' task.id %}">
                        {% csrf_token %}
                        <button type="submit">Mark as Completed</button>
                    </form>
                </li>
            {% empty %}
                <li>No available tasks.</li>
            {% endfor %}
        </ul>
    </div>

    <div class="task-column">
        <h3>Completed Tasks</h3>
        <ul>
            {% for task in completed_tasks %}
                <li>
                    <strong>{{ task.title }}</strong>
                    <p>{{ task.description }}</p>
                </li>
            {% empty %}
                <li>No completed tasks.</li>
            {% endfor %}
        </ul>
    </div>
</div>

<div id="map" style="height: 400px;"></div>  <!-- Ensure the map div has a height -->

<script>
// Initialize map variable globally
let map = null;
let userMarker = null;

// Function to initialize the map
function initMap() {
    // Create the map centered on a default location
    map = L.map('map').setView([0, 0], 13);

    // Add the OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Get user's current location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;

                // Center map on user's location
                map.setView([latitude, longitude], 15);

                // Add marker for user's location
                if (userMarker) {
                    userMarker.setLatLng([latitude, longitude]);
                } else {
                    userMarker = L.marker([latitude, longitude])
                        .addTo(map)
                        .bindPopup('Your current location')
                        .openPopup();
                }

                // Store location in cookies
                document.cookie = `user_latitude=${latitude}; path=/; max-age=3600`;
                document.cookie = `user_longitude=${longitude}; path=/; max-age=3600`;

                // Update location in database (if needed)
                updateVolunteerLocation(latitude, longitude);
            },
            function(error) {
                console.error("Error getting location:", error);
                alert("Unable to get your location. Please enable location services.");
            },
            {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            }
        );
    } else {
        alert("Geolocation is not supported by this browser.");
    }
}

// Function to update volunteer's location in the database
async function updateVolunteerLocation(latitude, longitude) {
    const url = '/api/volunteer/location/update/';
    console.log('Sending request to:', url);  // Debug log
    try {
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Update the fetch URL to match the new URL pattern
        const response = await fetch('/api/volunteer/location/update/', {  // Updated URL
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            credentials: 'include',
            body: JSON.stringify({
                latitude: latitude,
                longitude: longitude
            })
        });

        if (!response.ok) {
            throw new Error('Failed to update location');
        }

        const data = await response.json();
        console.log('Location updated successfully:', data);
    } catch (error) {
        console.error('Error updating location:', error);
    }
}

// Function to get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Watch for location changes
function watchLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
            function(position) {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;

                // Update marker position
                if (userMarker) {
                    userMarker.setLatLng([latitude, longitude]);
                }

                // Update stored location
                document.cookie = `user_latitude=${latitude}; path=/; max-age=3600`;
                document.cookie = `user_longitude=${longitude}; path=/; max-age=3600`;

                // Update location in database
                updateVolunteerLocation(latitude, longitude);
            },
            function(error) {
                console.error("Error watching location:", error);
            },
            {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            }
        );
    }
}

// Initialize map when the page loads
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    watchLocation();
});
</script>
{% endblock %}